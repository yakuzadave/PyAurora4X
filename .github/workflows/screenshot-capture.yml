name: UI Screenshot Capture

# Capture and publish UI screenshot as artifact
# This workflow generates an SVG screenshot of the PyAurora4X UI
# and publishes it as a GitHub Actions artifact

on:
  # Run on pushes to main branch
  push:
    branches:
      - main
  
  # Run on pull requests
  pull_request:
    branches:
      - main
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run weekly to keep screenshot up to date
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC

jobs:
  capture-screenshot:
    name: Capture UI Screenshot
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy "pydantic>=2.11.5" textual tinydb rebound duckdb pytest
      
      - name: Capture screenshot
        id: screenshot
        run: |
          echo "Capturing UI screenshot..."
          python capture_screenshot.py --output ui-screenshot.svg --wait 5
          
          # Check if screenshot was created
          if [ -f ui-screenshot.svg ]; then
            echo "Screenshot captured successfully"
            echo "screenshot_exists=true" >> $GITHUB_OUTPUT
            
            # Get file size for reporting
            SIZE=$(du -h ui-screenshot.svg | cut -f1)
            echo "screenshot_size=$SIZE" >> $GITHUB_OUTPUT
          else
            echo "Failed to capture screenshot"
            echo "screenshot_exists=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Upload screenshot artifact
        if: steps.screenshot.outputs.screenshot_exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ui-screenshot
          path: ui-screenshot.svg
          retention-days: 90
          if-no-files-found: error
      
      - name: Report results
        if: always()
        run: |
          echo "## Screenshot Capture Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.screenshot.outputs.screenshot_exists }}" == "true" ]; then
            echo "✅ **Success**: Screenshot captured and uploaded" >> $GITHUB_STEP_SUMMARY
            echo "- **File**: ui-screenshot.svg" >> $GITHUB_STEP_SUMMARY
            echo "- **Size**: ${{ steps.screenshot.outputs.screenshot_size }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Artifact**: Available in Actions artifacts for 90 days" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Failed**: Screenshot capture unsuccessful" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to Access" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to the Actions tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Select this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Download the 'ui-screenshot' artifact" >> $GITHUB_STEP_SUMMARY
